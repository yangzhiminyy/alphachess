"use strict";(self.webpackChunk_genie_chat_webview_app=self.webpackChunk_genie_chat_webview_app||[]).push([[5079],{2948:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ContextVariableUtils=void 0;t.ContextVariableUtils=class ContextVariableUtils{static toObject(e){const t={};for(const r of e)t[r.name]=r.value;return t}static toArray(e){const t=[];for(const[r,o]of Object.entries(e))t.push({name:r,value:o});return t}}},9467:function(e,t,r){var o=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,a=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(n<3?i(a):n>3?i(t,r,a):i(t,r))||a);return n>3&&a&&Object.defineProperty(t,r,a),a};Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultAuthenticationStorage=void 0;const i=r(15985),n=r(97317),a=r(70160);let s=class DefaultAuthenticationStorage{constructor(){this.storeSessionSubject=new n.BehaviorSubject(void 0)}async priority(){return a.AuthenticationStoragePriority.Low}async store(e){this.storeSessionSubject.next(e)}async restore(){return this.storeSessionSubject.getValue()}async clean(){this.storeSessionSubject.next(void 0)}};t.DefaultAuthenticationStorage=s,t.DefaultAuthenticationStorage=s=o([(0,i.Component)(a.AuthenticationStorage)],s)},11060:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},20573:function(e,t,r){var o=r(42649),i=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,a=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(n<3?i(a):n>3?i(t,r,a):i(t,r))||a);return n>3&&a&&Object.defineProperty(t,r,a),a},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.CustomTokenAuthenticationStorageImpl=t.CustomTokenAuthenticationStorage=void 0;const a=r(15985),s=r(26020),c=r(97317),u=r(70160),l=1999999999999;t.CustomTokenAuthenticationStorage=Symbol("CustomTokenAuthenticationStorage");let d=class CustomTokenAuthenticationStorageImpl{constructor(){this.storeSessionSubject=new c.BehaviorSubject(void 0)}async priority(){var e;return(null===(e=(await this.productManager.waitConfiguration()).authentication)||void 0===e?void 0:e.type)===s.AuthenticationType.CUSTOM_TOKEN?u.AuthenticationStoragePriority.Heigh:u.AuthenticationStoragePriority.Disabled}async store(e){}async restore(){var e,t;const r=null===(t=null===(e=(await this.productManager.waitConfiguration()).authentication)||void 0===e?void 0:e.attributes)||void 0===t?void 0:t.token;if(!r)throw new Error("token is undefined");const o={auth:{accessToken:r,expiresIn:l,expiresAt:l,refreshToken:"",refreshExpiresIn:l,refreshExpiresAt:l,tokenType:"Bearer",scope:""},account:{uid:this.getUserId(),nickname:this.getUsername(),type:"personal",lastLogin:!0},accounts:[{uid:this.getUserId(),nickname:this.getUsername(),type:"personal",lastLogin:!0}]};return this.storeSessionSubject.next(o),o}async clean(){}getUserId(){var e;return null!==(e=o.env.ACC_USER_ID)&&void 0!==e?e:this.getUsername()}getUsername(){return o.env.ACC_USER_NICKNAME?o.env.ACC_USER_NICKNAME:"anonymous"}};t.CustomTokenAuthenticationStorageImpl=d,i([(0,a.Autowired)(s.ProductManager),n("design:type",Object)],d.prototype,"productManager",void 0),t.CustomTokenAuthenticationStorageImpl=d=i([(0,a.Component)(u.AuthenticationStorage,t.CustomTokenAuthenticationStorage)],d)},22384:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},22847:function(e,t,r){var o=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,a=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(n<3?i(a):n>3?i(t,r,a):i(t,r))||a);return n>3&&a&&Object.defineProperty(t,r,a),a},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.UserInfoContextVariableResolver=void 0;const n=r(15985),a=r(63868),s=r(70160);let c=class UserInfoContextVariableResolver{constructor(){this.name="userInfo"}async priority(e,t){return this.authenticationManager.currentSessionSubject.getValue()?5:0}async resolve(e,t){const r=this.authenticationManager.currentSessionSubject.getValue();if(r)return{name:this.name,value:{id:r.account.uid,nickname:r.account.nickname}}}};t.UserInfoContextVariableResolver=c,o([(0,n.Autowired)(s.AuthenticationManager),i("design:type",Object)],c.prototype,"authenticationManager",void 0),t.UserInfoContextVariableResolver=c=o([(0,n.Component)(a.ContextVariableResolver)],c)},25079:function(e,t,r){var o=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,i)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||o(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),i(r(70160),t),i(r(61665),t),i(r(62386),t),i(r(22847),t),i(r(36034),t),i(r(9467),t),i(r(57327),t),i(r(20573),t)},27521:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},30634:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},31111:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},36034:function(e,t,r){var o=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,a=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(n<3?i(a):n>3?i(t,r,a):i(t,r))||a);return n>3&&a&&Object.defineProperty(t,r,a),a},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.AuthenticationHttpInterceptor=void 0;const n=r(15985),a=r(56464),s=r(2877),c=r(70160);let u=class AuthenticationHttpInterceptor{initialize(){this.restOperations.interceptors.request.use((e=>{e.headers||(e.headers={});const t=this.authenticationManager.currentSessionSubject.getValue();if(t){const{account:r,auth:o}=t;!e.headers[a.HttpHeaders.AUTHORIZATION]&&o.accessToken&&(e.headers[a.HttpHeaders.AUTHORIZATION]=`Bearer ${o.accessToken}`),!e.headers[c.HTTP_HEADER_USER_ID]&&(null==r?void 0:r.uid)&&(e.headers[c.HTTP_HEADER_USER_ID]=r.uid),!e.headers[c.HTTP_HEADER_ENTERPRISE_ID]&&(null==r?void 0:r.enterpriseId)&&(e.headers[c.HTTP_HEADER_ENTERPRISE_ID]=r.enterpriseId),!e.headers[c.HTTP_HEADER_TENANT_ID]&&(null==r?void 0:r.enterpriseId)&&(e.headers[c.HTTP_HEADER_TENANT_ID]=r.enterpriseId),!e.headers[c.HTTP_HEADER_DOMAIN]&&o.domain&&(e.headers[c.HTTP_HEADER_DOMAIN]=o.domain)}return e})),this.restOperations.interceptors.response.use((async e=>{var t;const r=null==e?void 0:e.data;try{401===(null==r?void 0:r.code)&&(null===(t=e.config.headers)||void 0===t?void 0:t.Authorization)&&this.checkToLogout(`${e.config.headers.Authorization}`,e.config.baseURL,e.config.url)}catch(e){this.logger.warn("Failed to get response code")}return e}),(e=>{var t,r;return 401===(null===(t=e.response)||void 0===t?void 0:t.status)&&(null===(r=e.response.config.headers)||void 0===r?void 0:r.Authorization)&&this.checkToLogout(`${e.response.config.headers.Authorization}`,e.response.config.baseURL,e.response.config.url),Promise.reject(e)}))}checkToLogout(e,t,r){var o,i;const n=`${e}`.substring(7),a=null===(i=null===(o=this.authenticationManager.currentSessionSubject.getValue())||void 0===o?void 0:o.auth)||void 0===i?void 0:i.accessToken;n&&n===a&&(this.logger.warn(`401 code logout, baseURL: ${t}, url: ${r}, current token: ${null==a?void 0:a.length}`),this.notifier.warn("Session expired. You have been automatically logged out."),this.authenticationManager.logout())}};t.AuthenticationHttpInterceptor=u,o([(0,n.Autowired)(c.AuthenticationManager),i("design:type",Object)],u.prototype,"authenticationManager",void 0),o([(0,n.Autowired)(a.RestOperations),i("design:type",Function)],u.prototype,"restOperations",void 0),o([(0,n.Autowired)(s.Notifier),i("design:type",Object)],u.prototype,"notifier",void 0),o([(0,n.Autowired)(n.Logger),i("design:type",Object)],u.prototype,"logger",void 0),t.AuthenticationHttpInterceptor=u=o([(0,n.Component)(n.ApplicationLifecycle)],u)},39045:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ContextVariableManager=t.ContextVariableResolver=t.ContextVariable=t.ContextVariableDefinition=void 0,t.ContextVariableDefinition=Symbol("ContextVariableDefinition"),t.ContextVariable=Symbol("ContextVariable"),t.ContextVariableResolver=Symbol("ContextVariableResolver"),t.ContextVariableManager=Symbol("ContextVariableManager")},43026:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),t.KnowledgeBaseType=void 0,function(e){e.Custom="custom",e.Common="common"}(r||(t.KnowledgeBaseType=r={}))},50251:(e,t)=>{var r;Object.defineProperty(t,"__esModule",{value:!0}),t.RelatedFileRelatedType=void 0,function(e){e.RECENTLY_OPENED="RECENTLY_OPENED",e.PATH_ASSOCIATED="PATH_ASSOCIATED",e.AST_DEPENDENCE="AST_DEPENDENCE",e.CURRENT_TEST="CURRENT_TEST",e.OTHER_TEST="OTHER_TEST"}(r||(t.RelatedFileRelatedType=r={}))},55589:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},56706:function(e,t,r){var o=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,a=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(n<3?i(a):n>3?i(t,r,a):i(t,r))||a);return n>3&&a&&Object.defineProperty(t,r,a),a},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.ContextVariableManagerImpl=void 0;const n=r(15985),a=r(39045);let s=class ContextVariableManagerImpl{constructor(){this.contextVariableResolvers=[],this.collectionContextVariableResolvers=[]}init(){this.logger.info("ContextVariableManagerImpl")}registerContextVariableResolver(e){this.collectionContextVariableResolvers.push(e)}async getContextVariable(e,t){return(await this.resolveContextVariables([e],t))[0]}async getContextVariables(e,t){const r=[...e||[]];return this.resolveContextVariables(r,t)}async getContextVariablesMap(e,t){return{...(await this.getContextVariables(e,t)).reduce(((e,t)=>(e[t.name]=t.value,e)),{})}}async resolveContextVariables(e,t){const r=[];for(const o of e){const e=await this.getResolver(o);if(!e)continue;const i=Date.now();try{const n=await e.resolve(o,t);this.logger.debug(`Resolved context variable: ${o.name} (${Date.now()-i}ms)`),n&&r.push(n)}catch(e){this.logger.error(`Failed to resolve ${o.name} context variable: ${e}`)}}return r}async getResolver(e,t){return(await this.prioritizeResolvers(e,t))[0]}getResolvers(e){return[...this.contextVariableResolvers,...this.collectionContextVariableResolvers].filter((t=>t.name===e))}async prioritizeResolvers(e,t){const r=this.getResolvers(e.name);if(!r)return[];return(await n.Prioritizeable.prioritizeAll(r,(async r=>{try{return await r.priority(e,t)}catch(e){return 0}}))).filter((e=>e.priority>0)).map((e=>e.value))}};t.ContextVariableManagerImpl=s,o([(0,n.Autowired)(a.ContextVariableResolver),i("design:type",Array)],s.prototype,"contextVariableResolvers",void 0),o([(0,n.Autowired)(n.Logger),i("design:type",Object)],s.prototype,"logger",void 0),o([(0,n.PostConstruct)(),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",void 0)],s.prototype,"init",null),t.ContextVariableManagerImpl=s=o([(0,n.Component)(a.ContextVariableManager)],s)},57327:function(e,t,r){var o=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,a=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(n<3?i(a):n>3?i(t,r,a):i(t,r))||a);return n>3&&a&&Object.defineProperty(t,r,a),a},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.CustomTokenAuthenticationProvider=void 0;const n=r(15985),a=r(26020),s=r(47392),c=r(70160),u=r(20573);let l=class CustomTokenAuthenticationProvider{async support(){var e;return(null===(e=(await this.productManager.waitConfiguration()).authentication)||void 0===e?void 0:e.type)===a.AuthenticationType.CUSTOM_TOKEN}async getAuthenticationType(){return[a.AuthenticationType.CUSTOM_TOKEN]}async createSession(e){const t=await this.customTokenAuthenticationStorage.restore();if(!t)throw new Error("authentication token is undefined");return t}async refreshSession(e,t){return e.auth.lastRefreshTime=Date.now(),e}async removeSession(e){}async switchAccount(e,t,r){return t}};t.CustomTokenAuthenticationProvider=l,o([(0,n.Autowired)(a.ProductManager),i("design:type",Object)],l.prototype,"productManager",void 0),o([(0,n.Autowired)(u.CustomTokenAuthenticationStorage),i("design:type",Object)],l.prototype,"customTokenAuthenticationStorage",void 0),o([(0,n.Autowired)(s.Logger),i("design:type",Object)],l.prototype,"logger",void 0),t.CustomTokenAuthenticationProvider=l=o([(0,n.Component)(c.AuthenticationProvider)],l)},59584:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},60022:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},61665:function(e,t,r){var o=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,a=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(n<3?i(a):n>3?i(t,r,a):i(t,r))||a);return n>3&&a&&Object.defineProperty(t,r,a),a},i=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.AuthenticationManagerImpl=void 0;const n=r(15985),a=r(56464),s=r(39322),c=r(26020),u=r(2877),l=r(47392),d=r(97317),h=r(90905),p=r(70160);let f=class AuthenticationManagerImpl{constructor(){this.authenticationStorages=[],this.initializedDeferred=new n.Deferred,this.initialized=this.initializedDeferred.promise,this.currentSessionSubject=new d.BehaviorSubject(void 0)}init(){this.logger.setContext("AuthenticationManager"),this.doInit()}async doInit(){const e=await this.getAuthenticationStorage();null==e||e.storeSessionSubject.pipe((0,h.distinctUntilChanged)(((e,t)=>JSON.stringify(e)===JSON.stringify(t)))).subscribe((e=>{this.currentSessionSubject.next(e),this.scheduleRefreshSession(),e&&this.productManager.sync(!0)})),await(null==e?void 0:e.restore()),this.initializedDeferred.resolve(),this.currentSessionSubject.subscribe((e=>{var t,r,o;(null===(t=null==e?void 0:e.account)||void 0===t?void 0:t.uid)&&(null===(r=this.filePathService)||void 0===r||r.setCurrentUserId(null===(o=null==e?void 0:e.account)||void 0===o?void 0:o.uid))}))}async login(e){var t,r,o,i;this.clearPendingSign();const n=await this.getAuthenticationProvider(),a=this.traceService.startTrace(l.SPAN_LOGIN);this.logger.info(`[${a.traceId}] Start login...`);try{this.pendingSignContext={abortController:new AbortController,traceSpan:a};const e=await n.createSession(this.pendingSignContext);return e?(e.auth.lastRefreshTime=Date.now(),await this.storeSession(e,a),a.markAsSuccessful(),this.eventService.report(l.Events.UserAuthAction,{userId:(null===(t=e.account)||void 0===t?void 0:t.uid)||"",username:(null===(r=e.account)||void 0===r?void 0:r.nickname)||"",userNickname:(null===(o=e.account)||void 0===o?void 0:o.nickname)||"",enterpriseId:(null===(i=e.account)||void 0===i?void 0:i.enterpriseId)||"",action:l.UserAuthActionType.Login,actionAt:Date.now()}),!0):(a.markAsFailed(),!1)}catch(e){return a.markAsFailed(e),this.logger.error(`sign in error: ${e}`),this.notifier.error("Login failed: {0}",[String(e)]),!1}}async logout(){var e,t,r,o;const i=await this.getAuthenticationStorage(),n=this.currentSessionSubject.getValue();n&&(await this.getAuthenticationProvider()).removeSession(n),null==i||i.clean(),this.eventService.report(l.Events.UserAuthAction,{userId:(null===(e=null==n?void 0:n.account)||void 0===e?void 0:e.uid)||"",username:(null===(t=null==n?void 0:n.account)||void 0===t?void 0:t.nickname)||"",userNickname:(null===(r=null==n?void 0:n.account)||void 0===r?void 0:r.nickname)||"",enterpriseId:(null===(o=null==n?void 0:n.account)||void 0===o?void 0:o.enterpriseId)||"",action:l.UserAuthActionType.Logout,actionAt:Date.now()})}async refreshSession(){await this.scheduleRefreshSession(!0)}async switchAccount(e){const t=this.currentSessionSubject.getValue();if(!t)return;this.clearPendingSign();const r=this.traceService.startTrace(l.SPAN_SWITCH_ACCOUNT);this.logger.info(`[${r.traceId}] Start switch account...`);const o={abortController:new AbortController,traceSpan:r};this.pendingSignContext=o;const i=await this.getAuthenticationProvider(),n=await i.switchAccount(e,t,o);n?(await this.storeSession(n,r),r.markAsSuccessful()):r.markAsFailed()}async waitAuthSession(){return new Promise((e=>{const t=this.currentSessionSubject.subscribe((r=>{r&&(e(r),setTimeout((()=>{t.unsubscribe()}),0))}))}))}clearPendingSign(){this.pendingSignContext&&(this.pendingSignContext.abortController.abort(),this.pendingSignContext=void 0)}async storeSession(e,t){const r=t.startSpan(l.SPAN_STORAGE_SESSION);try{const t=await this.getAuthenticationStorage();await(null==t?void 0:t.store(e)),r.markAsSuccessful()}catch(e){throw r.markAsFailed(e),e}}async scheduleRefreshSession(e,t=5){t--;const r=this.currentSessionSubject.getValue();if(!r)return;if(this.refreshTokenTimer&&(this.refreshTokenTimer.cancel(),this.refreshTokenTimer=void 0),!e){let e=864e5;(r.auth.expiresAt||0)-864e5<Date.now()&&(e=3e5);let t=e;const o=r.auth.lastRefreshTime||0;t=o+e<Date.now()?0:o+e-Date.now();const i=(0,n.timeout)(t);this.refreshTokenTimer=i,await i}const o=this.traceService.startTrace(l.SPAN_REFRESH_SESSION);this.logger.info(`[${o.traceId}] Start refresh session...`);try{const i=await this.getAuthenticationProvider();this.clearPendingSign(),this.pendingSignContext={abortController:new AbortController,traceSpan:o};const a=await i.refreshSession(r,this.pendingSignContext);a?(a.auth.lastRefreshTime=Date.now(),await this.storeSession(a,o),o.markAsSuccessful()):(o.markAsFailed(),this.logger.warn("refresh session error"),t>0&&(await(0,n.wait)(5e3),this.scheduleRefreshSession(e,t)))}catch(r){o.markAsFailed(r),this.logger.warn("refresh session error:",r),!(r instanceof p.UnauthorizedError)&&t>0&&(await(0,n.wait)(5e3),this.scheduleRefreshSession(e,t))}}async setAuthenticationProvider(e){let t;for(const r of this.authenticationProvider.get())if((await r.getAuthenticationType()).includes(e)){t=r;break}if(!t){const e=new s.NotFoundError("No available Authentication Provider found");throw this.logger.error(e),e}this.customAuthenticationProvider=t}async clearAuthenticationProvider(){this.customAuthenticationProvider=void 0}async getAuthenticationProvider(){if(this.customAuthenticationProvider)return this.customAuthenticationProvider;let e;for(const t of this.authenticationProvider.get())if(await t.support()){e=t;break}if(!e){const e=new s.NotFoundError("No available Authentication Provider found");throw this.logger.error(e),e}return e}async getAuthenticationStorage(){const e=(await n.Prioritizeable.prioritizeAll(this.authenticationStorages,(async e=>{try{return await e.priority()}catch(e){return 0}}))).filter((e=>e.priority>0)).map((e=>e.value))[0];if(!e){const e=new s.NotFoundError("No available Authentication Storage found");throw this.logger.error(e),e}return e}};t.AuthenticationManagerImpl=f,o([(0,n.Autowired)(c.ProductManager),i("design:type",Object)],f.prototype,"productManager",void 0),o([(0,n.AutowiredProvider)(p.AuthenticationProvider),i("design:type",Object)],f.prototype,"authenticationProvider",void 0),o([(0,n.Autowired)(p.AuthenticationStorage),i("design:type",Array)],f.prototype,"authenticationStorages",void 0),o([(0,n.Autowired)(l.EventService),i("design:type",Object)],f.prototype,"eventService",void 0),o([(0,n.Autowired)(l.TraceService),i("design:type",Object)],f.prototype,"traceService",void 0),o([(0,n.Autowired)(l.Logger),i("design:type",Object)],f.prototype,"logger",void 0),o([(0,n.Autowired)(a.RestOperations),i("design:type",Function)],f.prototype,"restOperations",void 0),o([(0,n.Autowired)(s.FilePathService),(0,n.Optional)(),i("design:type",Object)],f.prototype,"filePathService",void 0),o([(0,n.Autowired)(u.Notifier),i("design:type",Object)],f.prototype,"notifier",void 0),o([(0,n.PostConstruct)(),i("design:type",Function),i("design:paramtypes",[]),i("design:returntype",void 0)],f.prototype,"init",null),t.AuthenticationManagerImpl=f=o([(0,n.Component)(p.AuthenticationManager)],f)},62386:function(e,t,r){var o=r(54452).hp,i=this&&this.__decorate||function(e,t,r,o){var i,n=arguments.length,a=n<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(n<3?i(a):n>3?i(t,r,a):i(t,r))||a);return n>3&&a&&Object.defineProperty(t,r,a),a},n=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.ExternalLinkAuthenticationProvider=void 0;const a=r(15985),s=r(56464),c=r(26020),u=r(2877),l=r(47392),d=r(40996),h=r(70160),p=3e5;var f;!function(e){e[e.RetryFetchToken=11217]="RetryFetchToken",e[e.RetryFetchAccount=12151]="RetryFetchAccount"}(f||(f={}));let g=class ExternalLinkAuthenticationProvider{init(){this.logger.setContext("ExternalLinkAuthenticationProvider"),this.productManager.configuration.subscribe((e=>{this.configuration=e||{}}))}async support(){var e,t;return await this.productManager.waitConfiguration(),(null===(e=this.configuration.authentication)||void 0===e?void 0:e.type)===c.AuthenticationType.EXTERNAL_LINK||(null===(t=this.configuration.authentication)||void 0===t?void 0:t.type)===c.AuthenticationType.EXTERNAL_LINK_V2}async getAuthenticationType(){return[c.AuthenticationType.EXTERNAL_LINK,c.AuthenticationType.EXTERNAL_LINK_V2]}async createSession(e){const t=Date.now();let r;const o=new Promise(((e,t)=>{r=setTimeout((()=>t(new h.TimeoutError)),p)}));try{return Promise.race([(async()=>{const r=await this.fetchAuthState(e),o=e.traceSpan.startSpan(l.SPAN_OPEN_EXTERNAL_LINK);await this.openAuthUrl(r),o.markAsSuccessful();const i=await this.loopGetToken(r,t,e);return{account:await this.loopGetAccount(r,i,t,e),accounts:await this.getAccounts(i,e),auth:i}})(),o])}catch(e){throw r&&clearTimeout(r),this.logger.error(`createSession error: ${e}`),e}}async refreshSession(e,t){try{const{data:{data:r}}=await this.restOperations.post(`/v2${this.prefixPath}/auth/token/refresh`,{},{headers:{...this.enterpriseHeaders(e.auth),"X-Refresh-Token":e.auth.refreshToken,...t.traceSpan.requestHeaders}})||{data:{data:void 0}};if(r){r.lastRefreshTime=Date.now(),this.calculateExpiresAt(r);const e=await this.getAccounts(r,t),o=e.find((e=>e.lastLogin))||e[0];if(!o){const e=new h.SignError("Failed to refresh token: account is null");throw this.logger.error(e),e}return{account:o,auth:r,accounts:e}}}catch(e){if(this.logger.error(`refresh token error: ${e}`),this.isAuthenticationInvalidError(e))throw new h.UnauthorizedError(e)}throw new h.SignError("Failed to refresh token")}async removeSession(){}async switchAccount(e,t,r){var o,i,n,a;const{type:s,enterpriseId:c}=e,u="personal"===s?`/v2${this.prefixPath}/login/enterprise`:`/v2${this.prefixPath}/login/enterprise/${c}`;let l=1,d=t;for(;l>0;){l--;try{const{data:{data:t}}=await this.restOperations.post(u,{},{signal:null===(o=null==r?void 0:r.abortController)||void 0===o?void 0:o.signal,headers:{...this.enterpriseHeaders(d.auth),"X-Refresh-Token":d.auth.refreshToken,Authorization:`Bearer ${d.auth.accessToken}`,...r.traceSpan.requestHeaders}})||{data:{data:void 0}};if(t){t.domain=null!==(i=null==t?void 0:t.domain)&&void 0!==i?i:null===(n=d.auth)||void 0===n?void 0:n.domain,t.lastRefreshTime=Date.now(),this.calculateExpiresAt(t);return{account:e,accounts:await this.getAccounts(t,r),auth:t}}}catch(e){if(this.logger.error(`switch account error: ${e}`),403===(null===(a=null==e?void 0:e.response)||void 0===a?void 0:a.code)){d=await this.refreshSession(d,r);continue}if(await this.isIpLimitError(e))throw new h.SignIpLimitError;break}}throw new h.SignError("Failed to switch account")}async fetchAuthState(e){const t=e.traceSpan.startSpan(l.SPAN_GET_AUTH_STATE);try{const{data:{data:r}}=await this.restOperations.post(`/v2${this.prefixPath}/auth/state?platform=${this.configuration.platform}`,{},{headers:{...this.enterpriseHeaders()},...e.traceSpan.requestHeaders})||{data:{data:void 0}};if(r)return t.markAsSuccessful(),r;const o=new h.SignError("Failed to fetch auth state");throw t.markAsFailed(o),o}catch(e){throw this.logger.error(`fetch auth state error: ${e}`),t.markAsFailed(e),e}}async openAuthUrl(e){if(!this.externalUriOpener.open(e.authUrl))throw new h.OpenExternalLinkError}async loopGetToken(e,t,r){const o=r.traceSpan.startSpan(l.SPAN_GET_AUTH_TOKEN);for(;Date.now()-t<p;){if(await(0,a.wait)(1e3),r.abortController.signal.aborted)throw o.markAsFailed("Canceled"),new h.CanceledError;try{const{data:{data:t}}=await this.restOperations.get(`/v2${this.prefixPath}/auth/token?state=${e.state}`,{signal:r.abortController.signal,headers:{...r.traceSpan.requestHeaders}})||{data:{data:void 0}};if(t)return t.lastRefreshTime=Date.now(),this.calculateExpiresAt(t),o.markAsSuccessful(),t}catch(e){if((null==e?void 0:e.code)===f.RetryFetchToken)continue;throw this.logger.error(`fetch auth token error: ${e}`),o.markAsFailed(e),e}}throw o.markAsFailed("Timeout"),new h.TimeoutError}async loopGetAccount(e,t,r,o){const i=o.traceSpan.startSpan(l.SPAN_GET_ACCOUNT);for(;Date.now()-r<p;){if(await(0,a.wait)(1e3),o.abortController.signal.aborted)throw i.markAsFailed("Canceled"),new h.CanceledError;try{const{data:{data:r}}=await this.restOperations.get(`/v2${this.prefixPath}/login/account?state=${e.state}`,{signal:o.abortController.signal,headers:{...this.enterpriseHeaders(t),Authorization:`Bearer ${t.accessToken}`,...o.traceSpan.requestHeaders}})||{data:{data:void 0}};if(r)return i.markAsSuccessful(),r}catch(e){if((null==e?void 0:e.code)===f.RetryFetchAccount)continue;throw this.logger.error(`fetch auth account error: ${e}`),i.markAsFailed(e),e}}throw i.markAsFailed("Timeout"),new h.TimeoutError}async getAccounts(e,t){var r;const o=t.traceSpan.startSpan(l.SPAN_GET_ACCOUNT_LIST);try{const{data:{data:i}}=await this.restOperations.get(`/v2${this.prefixPath}/accounts`,{signal:t.abortController.signal,headers:{...this.enterpriseHeaders(e),Authorization:`Bearer ${e.accessToken}`,...t.traceSpan.requestHeaders}})||{data:{data:void 0}};if(null===(r=i.accounts)||void 0===r?void 0:r.length)return o.markAsSuccessful(),i.accounts.filter((e=>e.pluginEnabled))}catch(e){o.markAsFailed(e),this.logger.error(`fetch auth accounts error: ${e}`)}return o.markAsFailed("accounts is empty"),[]}enterpriseHeaders(e){var t;let r="";try{if(null==e?void 0:e.domain)r=e.domain;else{const e=(null===(t=this.configuration.authentication)||void 0===t?void 0:t.endpoint)||this.configuration.endpoint||"";r=d.URI.parse(e).authority}return{[h.HTTP_HEADER_DOMAIN]:r}}catch(e){return this.logger.warn(`endpoint domain format error: ${e}`),{}}}calculateExpiresAt(e){!e.expiresAt&&e.expiresIn&&(e.expiresAt=new Date(Date.now()+1e3*e.expiresIn).getTime()),!e.refreshExpiresAt&&e.refreshExpiresIn&&(e.refreshExpiresAt=new Date(Date.now()+1e3*e.refreshExpiresIn).getTime())}async isIpLimitError(e){var t;try{let r=null===(t=null==e?void 0:e.response)||void 0===t?void 0:t.data;return 10081===(null==r?void 0:r.code)||(r=JSON.parse(await this.streamToString(r)),10081===(null==r?void 0:r.code))}catch(e){return!1}}async streamToString(e){const t=[];return new Promise(((r,i)=>{e.on("data",(e=>t.push(o.from(e)))),e.on("error",(e=>i(e))),e.on("end",(()=>r(o.concat(t).toString("utf8"))))}))}isAuthenticationInvalidError(e){var t;if(e&&e.isAxiosError){const r=null===(t=e.response)||void 0===t?void 0:t.status;return 401===r||403===r}return!1}get endpoint(){var e;return(null===(e=this.configuration.authentication)||void 0===e?void 0:e.endpoint)||this.configuration.endpoint||""}get prefixPath(){var e,t;return(null===(t=null===(e=this.configuration.authentication)||void 0===e?void 0:e.attributes)||void 0===t?void 0:t.prefixPath)||""}};t.ExternalLinkAuthenticationProvider=g,i([(0,a.Autowired)(c.ProductManager),n("design:type",Object)],g.prototype,"productManager",void 0),i([(0,a.Autowired)(u.ExternalUriOpener),n("design:type",Object)],g.prototype,"externalUriOpener",void 0),i([(0,a.Autowired)(s.RestOperations),n("design:type",Function)],g.prototype,"restOperations",void 0),i([(0,a.Autowired)(l.Logger),n("design:type",Object)],g.prototype,"logger",void 0),i([(0,a.PostConstruct)(),n("design:type",Function),n("design:paramtypes",[]),n("design:returntype",void 0)],g.prototype,"init",null),t.ExternalLinkAuthenticationProvider=g=i([(0,a.Component)(h.AuthenticationProvider)],g)},63141:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},63868:function(e,t,r){var o=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,i)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||o(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),i(r(39045),t),i(r(56706),t),i(r(27521),t),i(r(2948),t),i(r(75058),t)},70160:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UnauthorizedError=t.SignIpLimitError=t.SignError=t.OpenExternalLinkError=t.CanceledError=t.TimeoutError=t.X_USER_ID=t.AuthenticationStoragePriority=t.HTTP_HEADER_DOMAIN=t.HTTP_HEADER_TENANT_ID=t.HTTP_HEADER_ENTERPRISE_ID=t.HTTP_HEADER_USER_ID=t.AuthenticationManager=t.AuthenticationStorage=t.AuthenticationProvider=t.AUTHENTICATION_PROVIDER_ID=void 0;const o=r(15985);var i;t.AUTHENTICATION_PROVIDER_ID="codingcopilot",t.AuthenticationProvider=Symbol("AuthenticationProvider"),t.AuthenticationStorage=Symbol("AuthenticationStorage"),t.AuthenticationManager=Symbol("AuthenticationManager"),t.HTTP_HEADER_USER_ID="X-User-Id",t.HTTP_HEADER_ENTERPRISE_ID="X-Enterprise-Id",t.HTTP_HEADER_TENANT_ID="X-Tenant-Id",t.HTTP_HEADER_DOMAIN="X-Domain",function(e){e[e.Disabled=0]="Disabled",e[e.Low=1]="Low",e[e.Normal=5]="Normal",e[e.Heigh=9]="Heigh"}(i||(t.AuthenticationStoragePriority=i={})),t.X_USER_ID="X-User-Id";class TimeoutError extends o.CustomError{}t.TimeoutError=TimeoutError;class CanceledError extends o.CustomError{}t.CanceledError=CanceledError;class OpenExternalLinkError extends o.CustomError{}t.OpenExternalLinkError=OpenExternalLinkError;class SignError extends o.CustomError{}t.SignError=SignError;class SignIpLimitError extends o.CustomError{}t.SignIpLimitError=SignIpLimitError;class UnauthorizedError extends o.CustomError{}t.UnauthorizedError=UnauthorizedError},71404:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},74427:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},74614:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},75058:function(e,t,r){var o=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,i)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||o(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),i(r(22384),t),i(r(74614),t),i(r(30634),t),i(r(60022),t),i(r(74427),t),i(r(80536),t),i(r(50251),t),i(r(59584),t),i(r(71404),t),i(r(11060),t),i(r(76482),t),i(r(43026),t),i(r(55589),t),i(r(94164),t),i(r(31111),t),i(r(63141),t)},76482:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},80536:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},94164:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})}}]);
//# sourceMappingURL=5079.c56179610caea4f63419.js.map