"use strict";(self.webpackChunk_genie_chat_webview_app=self.webpackChunk_genie_chat_webview_app||[]).push([[5833],{9670:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,a=arguments.length,i=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(i=(a<3?r(i):a>3?r(t,o,i):r(t,o))||i);return a>3&&i&&Object.defineProperty(t,o,i),i};Object.defineProperty(t,"__esModule",{value:!0}),t.TencentKnowledgeBaseProviderFactory=void 0;const r=o(15985),a=o(72396),i=o(59045);let s=class TencentKnowledgeBaseProviderFactory{async support(e){return e.provider===a.KnowledgeBaseProviderName.Tencent}async create(e){const t=r.ContainerUtil.get(i.TencentKnowledgeBaseProvider);return await t.initialize(e),t}};t.TencentKnowledgeBaseProviderFactory=s,t.TencentKnowledgeBaseProviderFactory=s=n([(0,r.Component)(a.KnowledgeBaseProviderFactory)],s)},13073:function(e,t,o){var n=this&&this.__createBinding||(Object.create?function(e,t,o,n){void 0===n&&(n=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,n,r)}:function(e,t,o,n){void 0===n&&(n=o),e[n]=t[o]}),r=this&&this.__exportStar||function(e,t){for(var o in e)"default"===o||Object.prototype.hasOwnProperty.call(t,o)||n(t,e,o)};Object.defineProperty(t,"__esModule",{value:!0}),r(o(72396),t),r(o(92253),t),r(o(9670),t),r(o(59045),t),r(o(74149),t)},59045:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,a=arguments.length,i=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(i=(a<3?r(i):a>3?r(t,o,i):r(t,o))||i);return a>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.TencentKnowledgeBaseProvider=void 0;const a=o(15985),i=o(56464),s=o(25079),c=o(26020),l=o(15076),d=o(72396);let u=class TencentKnowledgeBaseProvider{constructor(){this.configuration={},this.listCacheKey="",this.cache=[],this.pureList=(0,l.memoize)((async(e,t)=>{var o;try{const{data:{data:n}}=await this.restOperations.get(t,{baseURL:e});return this.logger.info(`fetch knowledgeBase from remote ,length : ${(null===(o=n.knowledge_bases)||void 0===o?void 0:o.length)||0}`),n.knowledge_bases||[]}catch(o){return this.logger.error(`knowledge base list error: [${e},${t}] ${o}`),[]}finally{setTimeout((()=>{var e,t;null===(t=(e=this.pureList.cache).clear)||void 0===t||t.call(e)}),d.MAX_CACHE_TTL)}}),((...e)=>this.listCacheKey=e.join("-")))}init(){this.logger.setContext("TencentKnowledgeBaseProvider")}async initialize(e){this.configuration=e,await this.list()}async list(){var e,t,o;if(!await this.authenticationManager.waitAuthSession())return[];const{baseURL:n,path:r}=await this.getBaseUrlAndPath(null!==(o=null===(t=null===(e=this.configuration)||void 0===e?void 0:e.attributes)||void 0===t?void 0:t.listPath)&&void 0!==o?o:"/knowledge-bases"),a=await this.pureList(n,r);return this.cache=a,a}sync(){var e,t;null===(t=(e=this.pureList.cache).clear)||void 0===t||t.call(e),this.list()}listSync(){return this.cache}async query(e){var t,o,n;if(!await this.authenticationManager.waitAuthSession())return[];const{baseURL:r,path:a}=await this.getBaseUrlAndPath(null!==(n=null===(o=null===(t=this.configuration)||void 0===t?void 0:t.attributes)||void 0===o?void 0:o.queryPath)&&void 0!==n?n:"/knowledge-bases/{knowledgeBaseId}/query"),i=[],s=await this.pureList.cache.get(this.listCacheKey)||[];if(e.knowledgeBaseIds)for(const t of e.knowledgeBaseIds)s.find((e=>e.id===t))&&i.push(t);if(0===i.length)return[];const c=[];return await Promise.all(i.map((async t=>{var o;const n=a.replace("{knowledgeBaseId}",t);try{const{data:{data:a}}=await this.restOperations.post(n,{query:e.text},{baseURL:r,signal:e.signal});null===(o=a.items)||void 0===o||o.forEach((e=>{e.knowledgeBaseId=t})),c.push(...a.items||[])}catch(e){this.logger.error(`knowledge base query error: [${r},${n}] ${e}`)}}))),c}async getBaseUrlAndPath(e){var t,o;const[n,r]=await Promise.all([this.authenticationManager.waitAuthSession(),this.productManager.waitConfiguration()]),a=this.configuration;let i=r.endpoint||"",s="/v2"+e;if(a.url&&(i=a.url,s=""),null===(t=n.account)||void 0===t?void 0:t.enterpriseId){const t=null===(o=null==a?void 0:a.attributes)||void 0===o?void 0:o.enterprisePath;s=t||`/v2/enterprises/{enterpriseId}${e}`,s=s.replace("{enterpriseId}",n.account.enterpriseId)}return{baseURL:i,path:s}}};t.TencentKnowledgeBaseProvider=u,n([(0,a.Autowired)(c.ProductManager),r("design:type",Object)],u.prototype,"productManager",void 0),n([(0,a.Autowired)(s.AuthenticationManager),r("design:type",Object)],u.prototype,"authenticationManager",void 0),n([(0,a.Autowired)(i.RestOperations),r("design:type",Function)],u.prototype,"restOperations",void 0),n([(0,a.Autowired)(a.Logger),r("design:type",Object)],u.prototype,"logger",void 0),n([(0,a.PostConstruct)(),r("design:type",Function),r("design:paramtypes",[]),r("design:returntype",void 0)],u.prototype,"init",null),t.TencentKnowledgeBaseProvider=u=n([(0,a.Component)({id:d.KnowledgeBaseProvider,scope:a.Scope.Request})],u)},65833:(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),o(13073);const n=o(15985);t.default=(0,n.autoBind)()},72396:(e,t)=>{var o,n;Object.defineProperty(t,"__esModule",{value:!0}),t.KnowledgeBaseType=t.KnowledgeBaseProviderName=t.INITIALIZE_DELAY=t.MAX_CACHE_TTL=t.KnowledgeBaseProviderFactory=t.KnowledgeBaseProvider=t.KnowledgeBaseManager=void 0,t.KnowledgeBaseManager=Symbol("KnowledgeBaseManager"),t.KnowledgeBaseProvider=Symbol("KnowledgeBaseProvider"),t.KnowledgeBaseProviderFactory=Symbol("KnowledgeBaseProviderFactory"),t.MAX_CACHE_TTL=18e5,t.INITIALIZE_DELAY=3e3,function(e){e.Tencent="Tencent"}(o||(t.KnowledgeBaseProviderName=o={})),function(e){e.Custom="custom",e.Common="common"}(n||(t.KnowledgeBaseType=n={}))},74149:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,a=arguments.length,i=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(i=(a<3?r(i):a>3?r(t,o,i):r(t,o))||i);return a>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.KnowledgeBaseContextVariableResolver=void 0;const a=o(15985),i=o(63868),s=o(72396);let c=class KnowledgeBaseContextVariableResolver{constructor(){this.name="knowledgeBase"}async priority(e,t){return 5}async resolve(e,t){var o,n;const r=await this.knowledgeBaseManager.query({text:(null===(o=e.resolveOptions)||void 0===o?void 0:o.text)||"",knowledgeBaseIds:(null===(n=null==e?void 0:e.resolveOptions)||void 0===n?void 0:n.knowledgeBaseIds)||[],signal:null==t?void 0:t.signal}),a={};for(const e of r)a[e.knowledgeBaseId]||(a[e.knowledgeBaseId]=[]),a[e.knowledgeBaseId].push(e);const i={name:this.name,value:[]};for(const[e,t]of Object.entries(a))i.value.push({knowledgeBaseId:e,references:t});return i}};t.KnowledgeBaseContextVariableResolver=c,n([(0,a.Autowired)(s.KnowledgeBaseManager),r("design:type",Object)],c.prototype,"knowledgeBaseManager",void 0),t.KnowledgeBaseContextVariableResolver=c=n([(0,a.Component)(i.ContextVariableResolver)],c)},92253:function(e,t,o){var n=this&&this.__decorate||function(e,t,o,n){var r,a=arguments.length,i=a<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,o):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,o,n);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(i=(a<3?r(i):a>3?r(t,o,i):r(t,o))||i);return a>3&&i&&Object.defineProperty(t,o,i),i},r=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};Object.defineProperty(t,"__esModule",{value:!0}),t.KnowledgeBaseManagerImpl=void 0;const a=o(15985),i=o(39322),s=o(26020),c=o(72396);let l=class KnowledgeBaseManagerImpl{constructor(){this.knowledgeBaseProviderFactories=[],this.lastKnowledgeBaseConfiguration=[],this.activeKnowledgeBaseProviders=[]}initialize(){this.doInitialize()}async doInitialize(){await(0,a.timeout)(c.INITIALIZE_DELAY),this.productManager.configuration.subscribe((e=>{const t=(null==e?void 0:e.knowledgeBases)||[];i.ObjectUtils.isChanged(this.lastKnowledgeBaseConfiguration,t)&&(this.initKnowledgeBaseProviders(t),this.lastKnowledgeBaseConfiguration=t)})),this.scheduleSync()}async scheduleSync(){await(0,a.timeout)(c.MAX_CACHE_TTL),this.sync(),this.scheduleSync()}sync(){for(const e of this.activeKnowledgeBaseProviders)e.list()}async list(){const e=[];for(const t of this.activeKnowledgeBaseProviders)e.push(...await t.list()||[]);return e}listSync(){const e=[];for(const t of this.activeKnowledgeBaseProviders)e.push(...t.listSync()||[]);return e}async query(e){const t=[];for(const o of this.activeKnowledgeBaseProviders)t.push(...await o.query(e)||[]);return t.sort(((e,t)=>t.score-e.score))}async initKnowledgeBaseProviders(e){const t=[],o=Object.fromEntries(e.filter((e=>e.provider)).map((e=>[e.provider,e])));for(const e of Object.values(o)){const o=await this.createKnowledgeBaseProvider(e);o&&t.push(o)}this.activeKnowledgeBaseProviders=t}async createKnowledgeBaseProvider(e){for(const t of this.knowledgeBaseProviderFactories)if(await t.support(e))return t.create(e)}};t.KnowledgeBaseManagerImpl=l,n([(0,a.Autowired)(s.ProductManager),r("design:type",Object)],l.prototype,"productManager",void 0),n([(0,a.Autowired)(c.KnowledgeBaseProviderFactory),(0,a.Optional)(),r("design:type",Array)],l.prototype,"knowledgeBaseProviderFactories",void 0),t.KnowledgeBaseManagerImpl=l=n([(0,a.Component)(c.KnowledgeBaseManager,a.ApplicationLifecycle)],l)}}]);
//# sourceMappingURL=5833.292fae31bbe1925cdf2a.js.map